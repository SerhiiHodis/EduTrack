{% extends "base.html" %}
{% load journal_filters %}

{% block title %}Управління користувачами{% endblock %}

{% block header_title %}Управління Користувачами{% endblock %}

{% block content %}
<div class="glass-panel rounded-3xl p-8 mb-8" role="region" aria-label="Панель управління користувачами">
    <div class="flex justify-between items-center mb-8">
        <h3 class="text-2xl font-bold text-dark">Список користувачів</h3>
        <button onclick="toggleForm()"
            class="btn bg-primary text-white shadow-button hover:bg-blue-600 hover:shadow-button-hover flex items-center gap-2 animate-fade-in">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Додати користувача
        </button>
    </div>

    <div class="glass-panel shadow-sm rounded-3xl p-6 mb-8 bg-white/80 border border-gray-100">
        <form method="GET" action="{% url 'users_list' %}"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Пошук (Ім'я / Email)</label>
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Введіть текст..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Роль</label>
                <select name="role"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                    <option value="">Всі ролі</option>
                    <option value="student" {% if request.GET.role|is_equal:'student' %}selected{% endif %}>Студенти
                    </option>
                    <option value="teacher" {% if request.GET.role|is_equal:'teacher' %}selected{% endif %}>Викладачі
                    </option>
                    <option value="admin" {% if request.GET.role|is_equal:'admin' %}selected{% endif %}>Адміни</option>
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Група</label>
                <select name="group"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                    <option value="">Всі групи</option>
                    {% for g in groups %}
                    {% with group_id=g.id|stringformat:"s" %}
                    <option value="{{ g.id }}" {% if request.GET.group|is_equal:group_id %}selected{% endif %}>
                        {{ g.name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Предмет (для викл.)</label>
                <select name="subject"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary text-sm">
                    <option value="">Всі предмети</option>
                    {% for sub in all_subjects %}
                    {% with sub_id=sub.id|stringformat:"s" %}
                    <option value="{{ sub.id }}" {% if request.GET.subject|is_equal:sub_id %}selected{% endif %}>
                        {{ sub.name }}
                    </option>
                    {% endwith %}
                    {% endfor %}
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500 uppercase">Дата реєстрації</label>
                <div class="flex gap-2">
                    <input type="date" name="date_from" value="{{ request.GET.date_from }}"
                        class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                    <input type="date" name="date_to" value="{{ request.GET.date_to }}"
                        class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
                </div>
            </div>

            <div class="lg:col-span-3 flex justify-end gap-3 mt-2 border-t pt-4">
                <a href="{% url 'users_list' %}"
                    class="px-6 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                    Скинути все
                </a>
                <button type="submit"
                    class="px-8 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 shadow-md transition">
                    Застосувати фільтри
                </button>
            </div>
        </form>
    </div>

    <div id="addForm" class="hidden glass-panel bg-white/50 rounded-2xl p-6 mb-8 animate-slide-down" aria-hidden="true">
        <h4 class="text-xl font-bold text-dark mb-6">Додати нового користувача</h4>
        <form method="POST" action="{% url 'users_list' %}" class="space-y-4">
            {% csrf_token %}
            <div class="space-y-1">
                <input type="text" name="full_name" placeholder="ПІБ" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1">
                <input type="email" name="email" placeholder="Email" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1">
                <select name="role" required onchange="updateFormFields()"
                    class="role-select w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200 cursor-pointer">
                    <option value="" disabled selected>Виберіть роль</option>
                    <option value="admin">Адміністратор</option>
                    <option value="teacher">Викладач</option>
                    <option value="student">Студент</option>
                </select>
            </div>
            <div class="space-y-1">
                <input type="password" name="password" placeholder="Пароль" required
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
            </div>
            <div class="space-y-1 group-field" style="display: none;">
                <select name="group"
                    class="w-full px-4 py-3 border border-tableBorder rounded-xl text-dark bg-white focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200">
                    <option value="">Оберіть групу</option>
                    {% for group in groups %}
                    <option value="{{ group.pk }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="space-y-2 subjects-field" style="display: none;">
                <label class="font-medium text-dark">Предмети (для викладачів):</label>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    {% for subject in all_subjects %}
                    <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-primary/5 cursor-pointer">
                        <input type="checkbox" name="subjects" value="{{ subject.pk }}">
                        <span class="text-bodyText">{{ subject.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="submit"
                    class="btn bg-primary text-white shadow-button hover:bg-blue-600 py-2 px-6">Зберегти</button>
                <button type="button" onclick="toggleForm()"
                    class="btn bg-gray-400 text-white py-2 px-6">Скасувати</button>
            </div>
        </form>
    </div>

    <div class="overflow-x-auto rounded-xl border border-tableBorder bg-white shadow-sm mt-8">
        <table id="users-table" class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="bg-primary text-white p-4 text-left text-xs font-bold uppercase tracking-wider">ID</th>
                    <th class="bg-primary text-white p-4 text-left text-xs font-bold uppercase tracking-wider">ПІБ</th>
                    <th class="bg-primary text-white p-4 text-left text-xs font-bold uppercase tracking-wider">Роль</th>
                    <th class="bg-primary text-white p-4 text-left text-xs font-bold uppercase tracking-wider">Email
                    </th>
                    <th class="bg-primary text-white p-4 text-left text-xs font-bold uppercase tracking-wider">Група /
                        Предмети</th>
                    <th class="bg-primary text-white p-4 text-right text-xs font-bold uppercase tracking-wider">Дії</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-tableBorder text-dark">
                {% for user in users %}
                <tr
                    class="{% cycle 'bg-tableBgLight' 'bg-tableBgDark' %} hover:bg-primary/10 transition-colors duration-200">
                    <td class="p-4 font-medium">{{ user.pk }}</td>
                    <td class="p-4 font-medium">{{ user.full_name }}</td>
                    <td class="p-4">
                        {% if user.role == 'admin' %}
                        <span
                            class="px-2 py-1 rounded-md bg-purple-100 text-purple-700 text-xs font-bold uppercase">Адмін</span>
                        {% elif user.role == 'teacher' %}
                        <span
                            class="px-2 py-1 rounded-md bg-blue-100 text-blue-700 text-xs font-bold uppercase">Викладач</span>
                        {% else %}
                        <span
                            class="px-2 py-1 rounded-md bg-green-100 text-green-700 text-xs font-bold uppercase">Студент</span>
                        {% endif %}
                    </td>
                    <td class="p-4">{{ user.email }}</td>

                    <td class="p-4 text-sm">
                        {% if user.role == 'teacher' %}
                        {# Отримуємо всі призначення викладача #}
                        {% with assignments=user.teachingassignment_set.all %}
                        {% if assignments %}
                        <div class="flex flex-wrap gap-1 max-w-[220px]"
                            title="{% for a in assignments %}{{ a.subject.name }}{% if not forloop.last %}, {% endif %}{% endfor %}">

                            {% for a in assignments %}
                            {% if forloop.counter <= 2 %} <span
                                class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 text-[11px] border border-blue-100 whitespace-nowrap">
                                {{ a.subject.name }}
                                </span>
                                {% endif %}
                                {% endfor %}

                                {% if assignments|length > 2 %}
                                <span class="text-primary font-bold cursor-help ml-1" title="Показати всі">...</span>
                                {% endif %}
                        </div>
                        {% else %}
                        <span class="text-gray-400">—</span>
                        {% endif %}
                        {% endwith %}
                        {% elif user.role == 'student' %}
                        {% if user.group %}
                        <span class="px-2 py-1 rounded-md bg-gray-100 text-gray-600 text-xs font-medium">
                            Група: {{ user.group.name }}
                        </span>
                        {% else %}
                        <span class="text-gray-400">Група не вказана</span>
                        {% endif %}
                        {% else %}
                        <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>

                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <a href="{% url 'user_edit' pk=user.pk %}"
                                class="p-2 rounded-lg bg-primary text-white hover:bg-blue-600 transition-colors">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </a>
                            <form method="POST" action="{% url 'user_delete' pk=user.pk %}" class="inline">
                                {% csrf_token %}
                                <button type="submit"
                                    onclick="return confirm('Ви впевнені, що хочете видалити користувача {{ user.full_name }}?')"
                                    class="p-2 rounded-lg bg-error text-white hover:bg-red-600 transition-colors">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="p-8 text-center text-neutral text-lg">Користувачів не знайдено.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    function toggleForm() {
        document.getElementById('addForm').classList.toggle('hidden');
    }

    function updateFormFields() {
        const role = document.querySelector('.role-select').value;
        document.querySelector('.group-field').style.display = (role === 'student') ? 'block' : 'none';
        document.querySelector('.subjects-field').style.display = (role === 'teacher') ? 'block' : 'none';
    }
</script>
{% endblock %}