{% extends "base.html" %}
{% load journal_filters %}

{% block title %}Мої Оцінки{% endblock %}
{% block header_title %}Журнал Оцінок{% endblock %}

{% block content %}
<div class="glass-panel rounded-3xl p-6 mb-8">
  <form method="GET" action="{% url 'student_grades' %}"
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">

    <div class="flex flex-col gap-1">
      <label class="text-xs font-bold text-gray-500 uppercase">Пошук (тема/коментар)</label>
      <input type="text" name="search" placeholder="Введіть текст..." value="{{ request.GET.search }}"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>

    <div class="flex flex-col gap-1">
      <label class="text-xs font-bold text-gray-500 uppercase">Предмет</label>
      <select name="subject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
        <option value="">Усі предмети</option>
        {% for sub in student_subjects %}
        {% with sub_id=sub.id|stringformat:"s" %}
        <option value="{{ sub.id }}" {% if request.GET.subject|is_equal:sub_id %}selected{% endif %}>
          {{ sub.name }}
        </option>
        {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="flex flex-col gap-1">
      <label class="text-xs font-bold text-gray-500 uppercase">Період</label>
      <div class="flex gap-2">
        <input type="date" name="date_from" value="{{ request.GET.date_from }}"
          class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
        <input type="date" name="date_to" value="{{ request.GET.date_to }}"
          class="w-full px-2 py-2 border border-gray-300 rounded-lg text-xs">
      </div>
    </div>

    <div class="flex flex-col gap-1">
      <label class="text-xs font-bold text-gray-500 uppercase">Оцінка (від-до)</label>
      <div class="flex gap-2">
        <input type="number" name="min_grade" placeholder="0" min="0" max="100" value="{{ request.GET.min_grade }}"
          class="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm">
        <input type="number" name="max_grade" placeholder="12" min="0" max="100" value="{{ request.GET.max_grade }}"
          class="w-full px-2 py-2 border border-gray-300 rounded-lg text-sm">
      </div>
    </div>

    <div class="lg:col-span-4 flex justify-end gap-3 mt-2 border-t pt-4">
      <a href="{% url 'student_grades' %}"
        class="px-6 py-2 rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
        Скинути все
      </a>
      <button type="submit" class="px-8 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 shadow-md transition">
        Застосувати фільтри
      </button>
    </div>
  </form>
</div>

<div class="glass-panel rounded-3xl p-0 overflow-hidden shadow-sm">
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Дата</th>
          <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Предмет</th>
          <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Тема / Тип</th>
          <th class="p-4 text-center text-xs font-bold text-gray-500 uppercase">Оцінка</th>
          <th class="p-4 text-left text-xs font-bold text-gray-500 uppercase">Коментар</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for entry in grades %}
        <tr class="hover:bg-blue-50/50 transition duration-150">
          <td class="p-4 text-sm font-medium text-gray-900 whitespace-nowrap">
            {{ entry.lesson.date|date:"d.m.Y" }}
            <div class="text-xs text-gray-400">{{ entry.lesson.date|date:"l" }}</div>
          </td>
          <td class="p-4 text-sm text-gray-700">
            <div class="font-bold">{{ entry.lesson.subject.name }}</div>
            <div class="text-xs text-gray-500">{{ entry.lesson.teacher.full_name }}</div>
          </td>
          <td class="p-4 text-sm">
            <span
              class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-blue-100 text-blue-700 mb-1">
              {{ entry.lesson.evaluation_type.name }}
            </span>
            {% if entry.lesson.topic %}
            <div class="text-xs text-gray-600 truncate max-w-[200px]" title="{{ entry.lesson.topic }}">
              {{ entry.lesson.topic }}
            </div>
            {% endif %}
          </td>
          <td class="p-4 text-center">
            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full font-bold text-lg 
                            {% if entry.earned_points >= 10 %}bg-green-100 text-green-700
                            {% elif entry.earned_points >= 7 %}bg-blue-100 text-blue-700
                            {% elif entry.earned_points >= 4 %}bg-yellow-100 text-yellow-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
              {{ entry.earned_points|floatformat:0 }}
            </div>
          </td>
          <td class="p-4 text-sm text-gray-500 italic">
            {{ entry.comment|default:"—" }}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="p-12 text-center text-gray-400">
            <p class="text-lg">Записів не знайдено</p>
            <p class="text-sm">Спробуйте змінити параметри пошуку</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}